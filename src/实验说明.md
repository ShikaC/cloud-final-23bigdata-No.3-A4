# 题目4：虚拟化 vs 容器性能与隔离对比（精简版）

本项目聚焦于**KVM**与**Docker**运行轻量化 Nginx 的核心指标：启动时间、CPU 占用、内存占用、磁盘占用，以及压测表现。所有结果统一汇总为 CSV，并输出图表，方便直接复现实验和展示。

---

## 1. 环境准备

**支持系统**：Linux（Ubuntu 20.04/22.04 推荐），需 root（sudo）权限。

**必须组件**
- KVM/QEMU + libvirt：`sudo apt-get install -y qemu-kvm libvirt-daemon-system libvirt-clients virt-install qemu-utils`
- Docker：`sudo apt-get install -y docker.io`
- 压测工具：`sudo apt-get install -y apache2-utils`（提供 `ab`）
- Python 3 + 依赖：`pip3 install -r requirements.txt`

> 如果未安装，脚本会输出 0 占位数据，确保流程不中断，但请按上方步骤安装后再跑正式实验。

---

## 2. 一键运行

```bash
cd src
chmod +x *.sh
sudo ./run_experiment.sh
```

运行完成后关注：
- 性能数据：`src/results/performance.csv`
- 压测数据：`src/results/stress.csv`
- 图表输出：`src/results/visualization/`

> 默认使用 `nginx:alpine`（Docker）与 Ubuntu 22.04 cloud image（KVM），监听端口 8080。

---

## 3. 结果产出格式

### 3.1 性能指标（performance.csv）
列说明：`platform,startup_time_sec,cpu_percent,memory_mb,disk_mb`
- platform：`kvm` / `docker`
- startup_time_sec：从启动命令到服务可用耗时
- cpu_percent：2 秒窗口采样的 CPU 占用（占总 vCPU 比例）
- memory_mb：内存占用
- disk_mb：镜像/虚机磁盘占用

### 3.2 压测指标（stress.csv）
列说明：`platform,qps,avg_latency_ms,failed,transfer_kbps`
- platform：`kvm` / `docker`
- qps：Requests per second
- avg_latency_ms：平均响应时间
- failed：失败请求数
- transfer_kbps：吞吐（KB/s）

### 3.3 可视化
生成于 `results/visualization/`：
- `performance_comparison.png`：启动时间、CPU、内存、磁盘对比
- `stress_comparison.png`：QPS 与平均延迟对比

---

## 4. 分步执行（可按需调用）

1) **KVM 性能采集**
```bash
sudo bash vm_test.sh \
  --vm-name kvm-nginx \
  --app-port 8080 \
  --output-dir ./results/kvm \
  --perf-csv ./results/performance.csv
```

2) **Docker 性能采集**
```bash
bash docker_test.sh \
  --container-name docker-nginx \
  --app-port 8080 \
  --output-dir ./results/docker \
  --perf-csv ./results/performance.csv
```

3) **压测**
```bash
bash stress_test.sh \
  --vm-url http://<VM_IP>:8080 \
  --docker-url http://localhost:8080 \
  --requests 2000 \
  --concurrency 50 \
  --output-dir ./results \
  --output-csv ./results/stress.csv
```

4) **生成图表**
```bash
python3 visualize_results.py \
  --performance-csv ./results/performance.csv \
  --stress-csv ./results/stress.csv \
  --output-dir ./results/visualization
```

---

## 5. 目录与文件
```
src/
├── run_experiment.sh      # 一键执行：KVM+Docker+压测+可视化
├── vm_test.sh             # KVM 部署+指标采集，写入 performance.csv
├── docker_test.sh         # Docker 部署+指标采集，写入 performance.csv
├── stress_test.sh         # ab 压测，写入 stress.csv
├── visualize_results.py   # 读取两份 CSV 生成图表
├── requirements.txt
└── results/
    ├── performance.csv
    ├── stress.csv
    └── visualization/
        ├── performance_comparison.png
        └── stress_comparison.png
```

---

## 6. 常见问题
- **端口被占用**：脚本默认使用 8080，如冲突可在各脚本通过 `--app-port` 调整。
- **缺少工具**：若未安装 Docker/KVM/ab，会写入 0 占位行；请先安装后重跑。
- **KVM 网络获取 IP 失败**：确保 `libvirtd` 与默认网络 `virbr0` 已启动，或手动在 `results/kvm/vm_ip.txt` 写入可达 IP 后重跑压测步骤。
- **图表中文乱码**：安装任一中文字体（如 `fonts-noto-cjk`），或在脚本中替换字体名单。

---

通过以上精简流程，任何用户只需运行一次脚本即可获得题目 4 所需的性能对比与可视化结果。
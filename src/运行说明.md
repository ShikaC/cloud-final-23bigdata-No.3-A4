# 虚拟机测试运行说明

> **重要提示**：
> - 本版本已**不再使用 KVM/嵌套虚拟化**
> - 直接在 **VMWare Linux 虚拟机**上运行测试
> - 如果看到 KVM 相关错误，说明使用了旧版本脚本
> - **请先运行版本检查**: `bash check_version.sh`
> - **如遇端口8080被占用**，请参考 [端口配置说明.md](端口配置说明.md)

## 零、版本检查（重要！）

**如果遇到 KVM 相关错误，请先运行版本检查**：

```bash
cd src
bash check_version.sh
```

这会检查你的脚本是否为最新版本。如果检测到问题，请按提示操作。

## 一、环境要求

- **系统**: Ubuntu 20.04/22.04, Debian 11/12, CentOS 7/8 等
- **权限**: 需要 sudo 权限
- **网络**: 需要互联网连接（首次运行）
- **配置**: 建议 2+ 核心 CPU, 4+ GB 内存

## 二、端口配置（新功能）

### 默认端口
实验默认使用 **端口 8080**。如果该端口被占用，您有以下选择：

#### 选项1：自动处理（推荐）
```bash
bash run_experiment.sh --auto-port
```

#### 选项2：指定其他端口
```bash
bash run_experiment.sh --port 9090
```

#### 选项3：释放端口
```bash
# 查看占用端口的进程
bash port_manager.sh info 8080

# 释放端口（杀死占用进程）
bash port_manager.sh kill 8080
```

#### 选项4：使用环境变量
```bash
export APP_PORT=9090
bash run_experiment.sh
```

> 📖 **详细说明**：请参考 [端口配置说明.md](端口配置说明.md)

## 三、快速开始

### 在 VMWare Linux 虚拟机中运行：

```bash
# 1. 进入 src 目录
cd src

# 2. 运行 VM 测试（会自动安装依赖）
bash vm_test.sh

# 3. 查看结果
cat results/vm/metrics.csv
```

就这么简单！脚本会自动：
- 检查并安装 Nginx
- 检查并安装其他必需工具（curl, python3）
- 配置并启动 Nginx
- 采集性能数据
- 输出结果到 `results/vm/` 目录

## 四、完整实验流程（推荐）

运行完整的对比实验（VM + Docker + 压测 + 可视化）：

```bash
# 一键运行（自动安装依赖）
bash run_experiment.sh

# 或跳过依赖安装（如已安装）
bash run_experiment.sh --skip-deps
```

**脚本会自动完成**：
1. ✅ 检查系统环境（OS、CPU、内存、磁盘、网络）
2. ✅ 安装缺失的依赖（Nginx、Docker、Python等）
3. ✅ 运行 VM 测试
4. ✅ 运行 Docker 测试
5. ✅ 执行压力测试
6. ✅ 生成可视化图表
7. ✅ 显示详细结果报告

## 四、自定义参数

```bash
# 使用自定义端口
bash vm_test.sh --app-port 9090

# 指定输出目录
bash vm_test.sh --output-dir ./my_results

# 指定性能CSV文件
bash vm_test.sh --perf-csv ./performance.csv
```

## 五、输出说明

运行后会生成：

```
results/vm/
├── metrics.csv    # 详细指标数据
└── vm_ip.txt      # VM IP地址
```

`metrics.csv` 包含：
- `startup_time_sec`: 启动时间（秒）
- `cpu_percent`: CPU使用率（%）
- `memory_mb`: 内存占用（MB）
- `disk_mb`: 磁盘占用（MB）
- `vm_ip`: VM IP地址

## 六、常见问题

### Q1: 端口被占用
```bash
# 方法1: 使用其他端口
bash vm_test.sh --app-port 9090

# 方法2: 停止占用端口的服务
sudo systemctl stop nginx
```

### Q2: Docker 权限不足（permission denied）

**现象**：
```
permission denied while trying to connect to the Docker daemon socket
```

**解决方案**：

**方法 1：将用户加入 docker 组（推荐）**
```bash
# 将当前用户加入 docker 组
sudo usermod -aG docker $USER

# 激活组权限（三选一）
# 选项 1：重新登录系统
# 选项 2：使用 newgrp
newgrp docker
# 选项 3：在新 shell 中运行
su - $USER
```

**方法 2：使用 sudo 运行（临时方案）**
```bash
sudo bash run_experiment.sh
```

**方法 3：脚本会自动处理**
- 运行 `run_experiment.sh` 时会自动检查并尝试修复 Docker 权限
- 如果无法自动修复，会提示使用 sudo

### Q3: Python 包安装警告（--break-system-packages）

**现象**：
```
[警告] 使用 --break-system-packages 标志安装到系统Python
```

**说明**：
- 这是正常的警告，不影响使用
- 脚本会优先尝试创建 Python 虚拟环境
- 如果创建失败，会使用 --break-system-packages 作为备选方案

**解决方案（可选）**：
```bash
# 手动创建虚拟环境
cd src
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt

# 然后运行实验
bash run_experiment.sh --skip-deps
```

### Q4: 安装依赖失败
```bash
# 手动安装依赖
sudo apt-get update
sudo apt-get install -y nginx docker.io curl python3 python3-pip apache2-utils
```

### Q5: 从 Windows 复制后无法运行

**现象**：脚本报错或无法执行

**解决方案**：
```bash
# 安装 dos2unix
sudo apt-get install -y dos2unix

# 转换所有脚本
cd src
find . -name "*.sh" -exec dos2unix {} \;

# 添加执行权限
chmod +x *.sh

# 重新运行
bash run_experiment.sh
```

### Q6: KVM/虚拟化相关错误（已弃用）

**现象**：
```
缺少依赖/能力: /dev/kvm
在 WSL/虚拟机中需开启嵌套虚拟化
```

**说明**：
- 这个错误不应该出现，说明使用了旧版本的脚本
- 新版本已经不使用 KVM，直接在虚拟机上运行

**解决方案**：
```bash
# 确保使用最新版本的脚本
cd src
bash vm_test.sh  # 应该直接运行，不需要 KVM
```

## 七、清理环境

运行后清理测试环境：

```bash
bash cleanup.sh
```

## 八、原理说明

### 修改内容
原版本使用 WSL + KVM 嵌套虚拟化，现改为直接在 VMWare 虚拟机上运行测试。

**原版本**：
```
WSL → KVM → Ubuntu VM → Nginx
```

**新版本**：
```
VMWare VM → Nginx (直接运行)
```

### 测试含义
- **VM 测试**: 测试 VMWare 虚拟机环境的性能
- **Docker 测试**: 测试容器环境的性能
- **对比意义**: 体现虚拟化技术 vs 容器技术的性能差异

## 九、技术细节

### 性能监控方式
- **CPU**: 读取 `/proc/stat` 计算使用率
- **内存**: 使用 `free` 命令获取内存使用
- **磁盘**: 统计 Nginx 二进制和配置文件大小
- **启动时间**: 测量从启动到服务就绪的时间

### 自动化特性
脚本会自动：
1. 检测操作系统类型
2. 安装缺失的软件包（Nginx, curl, python3）
3. 检查并释放端口占用
4. 配置独立的 Nginx 实例（不影响系统 Nginx）
5. 采集系统性能数据
6. 生成标准格式的 CSV 输出

## 十、获取帮助

- 查看脚本帮助: `bash vm_test.sh --help` (如果脚本支持)
- 查看完整文档: 项目根目录的 README.md
- 查看安装脚本: `install_dependencies.sh`
- 查看清理脚本: `cleanup.sh`

---

**提示**: 首次运行会自动安装 Nginx，需要等待几分钟。后续运行会很快。

